<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kanban Board with Editable Modal, Preview & LocalStorage</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Modal overlay with background blur */
    #modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(5px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }
    /* Modal container */
    #modal-container {
      background: white;
      padding: 1rem;
      border-radius: 0.5rem;
      width: 20rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
    /* Drop placeholder styling */
    .drop-placeholder {
      border: 2px dashed #000;
      background-color: rgba(0,0,0,0.1);
      margin: 0.5rem 0;
    }
    /* Optional board highlight on drag */
    .drag-over {
      background-color: #f0f0f0;
    }
  </style>
</head>
<body class="flex flex-col">
  <!-- Board Container -->
  <section id="board" class="flex h-[80vh] w-[100vw] gap-2 items-start p-2 text-center overflow-auto"></section>
  <!-- Button to create new column -->
  <button id="create" class="self-start mt-4 ml-2 p-2 border rounded">Create Column</button>
  
  <!-- Preview Area -->
  <pre id="preview" class="p-4 m-4 border bg-gray-100 text-sm overflow-auto max-h-60"></pre>
  
  <!-- Modal for editing (todo or column) -->
  <div id="modal" class="flex">
    <div id="modal-container" class="flex flex-col space-y-4">
      <h2 id="modal-title" class="text-xl font-bold">Edit Item</h2>
      <input id="modal-input" type="text" class="w-full border p-2" placeholder="Enter text here" />
      <div class="flex justify-end space-x-2">
        <button id="modal-save" class="px-4 py-2 bg-green-500 text-white rounded">Save</button>
        <button id="modal-delete" class="px-4 py-2 bg-red-500 text-white rounded">Delete</button>
        <button id="modal-cancel" class="px-4 py-2 bg-gray-500 text-white rounded">Cancel</button>
      </div>
    </div>
  </div>
  
  <script>

    let currentEditingElement = null;
    let currentEditingType = null; 
    
    document.addEventListener('DOMContentLoaded', () => {
      loadBoardState();
      attachCreateColumnHandler();
    });
    
    // open modal
    function openModal(type, element) {
      currentEditingType = type;
      currentEditingElement = element;
      const modal = document.getElementById("modal");
      const modalTitle = document.getElementById("modal-title");
      const modalInput = document.getElementById("modal-input");

      if (type === "todo") {
        modalTitle.innerText = "Edit Todo";
        // For a todo, the text is inside the child <span>
        const span = element.querySelector("span");
        modalInput.value = span ? span.innerText : element.innerText;
      } else if (type === "column") {
        modalTitle.innerText = "Edit Column";
        // For a column, the text is inside the header h1
        const header = element.querySelector(".header h1");
        modalInput.value = header ? header.innerText : "";
      }
      modal.style.display = "flex";
    }
    
    // close model
    function closeModal() {
      const modal = document.getElementById("modal");
      modal.style.display = "none";
      currentEditingElement = null;
      currentEditingType = null;
    }
    
    // save the model
    document.getElementById("modal-save").addEventListener("click", function() {
      const modalInput = document.getElementById("modal-input");
      const newValue = modalInput.value;
      if (currentEditingElement) {
        if (currentEditingType === "todo") {
          const span = currentEditingElement.querySelector("span");
          if (span) span.innerText = newValue;
          else currentEditingElement.innerText = newValue;
        } else if (currentEditingType === "column") {
          const header = currentEditingElement.querySelector(".header h1");
          if (header) header.innerText = newValue;
        }
        saveBoardState();
      }
      closeModal();
    });
    
    // 
    document.getElementById("modal-delete").addEventListener("click", function() {
      if (currentEditingElement) {
        currentEditingElement.remove();
        saveBoardState();
      }
      closeModal();
    });
    
    document.getElementById("modal-cancel").addEventListener("click", function() {
      closeModal();
    });
    
    // Load board state from localStorage (or create default columns)
    function loadBoardState() {
      const board = document.querySelector('#board');
      board.innerHTML = "";
      const stored = localStorage.getItem('kanbanBoard');
      if (stored) {
        const state = JSON.parse(stored);
        state.columns.forEach(col => {
          board.appendChild(createColumnElement(col.title, col.todos));
        });
      } else {
        board.appendChild(createColumnElement("Todo", []));
        board.appendChild(createColumnElement("Progress", []));
        board.appendChild(createColumnElement("Done", []));
        saveBoardState();
      }
      DragEnable();
    }
    
    // Create a column element with header (including "Edit" and "Remove" buttons) and its todos.
    function createColumnElement(title, todos) {
      const div = document.createElement('div');
      div.classList.add("bord-items", "relative", "border", "p-2", "h-full", "flex-1", "max-w-[400px]", "flex", "flex-col");
    
      // Column header with title, Edit and Remove buttons
      const headerDiv = document.createElement('div');
      headerDiv.classList.add("header", "flex", "justify-between", "items-center");
      const h1 = document.createElement('h1');
      h1.innerHTML = title;
      h1.classList.add("font-bold", "text-2xl", "border-b");
      headerDiv.appendChild(h1);
      
      // Edit button for column
      const editColBtn = document.createElement('button');
      editColBtn.innerHTML = "Edit";
      editColBtn.classList.add("edit-column", "text-blue-500", "ml-2");
      editColBtn.addEventListener('click', (e) => {
        e.preventDefault();
        openModal("column", div);
      });
      headerDiv.appendChild(editColBtn);
      
      // Remove button for column
      const removeBtn = document.createElement('button');
      removeBtn.innerHTML = 'X';
      removeBtn.classList.add("remove-column", "text-red-500", "ml-2");
      removeBtn.addEventListener('click', (e) => {
        e.preventDefault();
        div.remove();
        saveBoardState();
      });
      headerDiv.appendChild(removeBtn);
      
      div.appendChild(headerDiv);
    
      // Button to add a new todo in this column
      const btn = document.createElement('button');
      btn.innerHTML = 'Add';
      btn.classList.add("mb-2", "absolute", "bottom-0", "left-0");
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        const value = prompt('Enter the todo:');
        if (!value) return;
        const todoElem = createTodoElement(value);
        div.appendChild(todoElem);
        saveBoardState();
        DragEnable();
      });
      div.appendChild(btn);
    
      // Append todos from saved state
      todos.forEach(todo => {
        // Each todo is stored as an object with text and opacity.
        const todoElem = createTodoElement(todo.text, todo.opacity);
        div.appendChild(todoElem);
      });
    
      return div;
    }
    
    // Create a draggable todo container with a text span, an Edit button, and dblclick removal.
    function createTodoElement(text, opacity = "1") {
      const container = document.createElement('div');
      container.classList.add('todo-item', 'border', 'p-2', 'bg-green-200', 'text-xl', 'rounded-md',
                                  'hover:bg-green-500', 'cursor-pointer', 'mt-2', 'flex', 'items-center', 'justify-between');
      container.setAttribute('draggable', true);
      container.style.opacity = opacity;
    
      const span = document.createElement('span');
      span.innerText = text;
      container.appendChild(span);
    
      const editButton = document.createElement('button');
      editButton.innerText = 'Edit';
      editButton.classList.add('ml-2', 'p-1', 'border', 'rounded', 'text-sm', 'bg-blue-200');
      editButton.addEventListener('click', (e) => {
        e.stopPropagation();
        openModal("todo", container);
      });
      container.appendChild(editButton);
    
      // Remove todo on double-click
      container.addEventListener('dblclick', (e) => {
        e.preventDefault();
        container.remove();
        saveBoardState();
      });
    
      // Drag events for the todo container
      container.addEventListener('dragstart', (e) => {
        e.dataTransfer.effectAllowed = "move";
        e.dataTransfer.setData("text/plain", "");
        container.classList.add('flying');
      });
      container.addEventListener('dragend', () => {
        container.classList.remove('flying');
        // Clean up any drop placeholder(s)
        document.querySelectorAll('.drop-placeholder').forEach(el => el.remove());
        saveBoardState();
      });
    
      return container;
    }
    
    // Enable drag & drop for all columns (reordering within the same column)
    // A drop placeholder shows where the item will be inserted.
    function DragEnable() {
      const boards = document.querySelectorAll('.bord-items');
      boards.forEach(board => {
        board.addEventListener('dragover', (event) => {
          event.preventDefault();
          event.dataTransfer.dropEffect = "move";
          board.classList.add('drag-over');
    
          const draggedElement = document.querySelector('.flying');
          if (!draggedElement) return;
    
          let placeholder = board.querySelector('.drop-placeholder');
          if (!placeholder) {
            placeholder = document.createElement('div');
            placeholder.classList.add('drop-placeholder');
            placeholder.style.height = draggedElement.offsetHeight + 'px';
          }
    
          const dropY = event.clientY;
          const todoItems = Array.from(board.querySelectorAll('.todo-item'))
                               .filter(item => item !== draggedElement);
    
          let inserted = false;
          for (const item of todoItems) {
            const rect = item.getBoundingClientRect();
            if (dropY < rect.top + rect.height / 2) {
              board.insertBefore(placeholder, item);
              inserted = true;
              break;
            }
          }
          if (!inserted) {
            board.appendChild(placeholder);
          }
        });
    
        board.addEventListener('dragleave', () => {
          board.classList.remove('drag-over');
          const placeholder = board.querySelector('.drop-placeholder');
          if (placeholder) placeholder.remove();
        });
    
        board.addEventListener('drop', (event) => {
          event.preventDefault();
          board.classList.remove('drag-over');
          const draggedElement = document.querySelector('.flying');
          if (draggedElement) {
            const placeholder = board.querySelector('.drop-placeholder');
            if (placeholder) {
              board.insertBefore(draggedElement, placeholder);
              placeholder.remove();
            } else {
              board.appendChild(draggedElement);
            }
            // Set opacity to 50% upon drop
            draggedElement.style.opacity = "0.5";
            draggedElement.classList.remove('flying');
            saveBoardState();
          }
        });
      });
    }
    
    // Save board state to localStorage and update the preview area.
    // Each todo is stored as an object with text and opacity.
    function saveBoardState() {
      const board = document.querySelector('#board');
      const columns = [];
      board.querySelectorAll('.bord-items').forEach(col => {
        let title;
        const header = col.querySelector('.header');
        if (header) {
          title = header.querySelector('h1').innerText;
        } else {
          title = col.querySelector('h1').innerText;
        }
        const todos = [];
        col.querySelectorAll('.todo-item').forEach(todo => {
          const span = todo.querySelector('span');
          todos.push({ text: span.innerText, opacity: todo.style.opacity || "1" });
        });
        columns.push({ title, todos });
      });
      const state = { columns };
      localStorage.setItem('kanbanBoard', JSON.stringify(state));
      updatePreview(state);
    }
    
    // Update preview area with the current board state (JSON formatted)
    function updatePreview(state) {
      const preview = document.querySelector('#preview');
      preview.innerText = JSON.stringify(state, null, 2);
    }
    
    // Attach event handler to create new columns via a prompt.
    function attachCreateColumnHandler() {
      const create = document.querySelector('#create');
      create.addEventListener('click', (e) => {
        e.preventDefault();
        const value = prompt("Enter the column name");
        if (!value) return;
        const newCol = createColumnElement(value, []);
        document.querySelector('#board').appendChild(newCol);
        saveBoardState();
        DragEnable();
      });
    }
  </script>
</body>
</html>
